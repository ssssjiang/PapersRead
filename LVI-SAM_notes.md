# LVI-SAM论文阅读笔记

Shan, T. , et al. "LVI-SAM: Tightly-coupled Lidar-Visual-Inertial Odometry via Smoothing and Mapping." (2021).

LVI-SAM开源代码链接：https://github.com/TixiaoShan/LVI-SAM

## 论文笔记

### 介绍

LVI-SAM，是一种**雷达、视觉、IMU紧耦合的里程计框架**，能够实时进行状态估计和建图，且具有较高的准确性和鲁棒性。主要输入传感器包括：一个3D雷达，一个单目相机，和一个IMU。

LVI-SAM是基于因子图进行构建的，主要**包含两个子系统：视觉惯性系统（VIS）和雷达惯性系统（LIS）**。VIS改写自VINS，LIS改写自LIO-SAM。两个子系统在设计上具有较高的耦合度，主要表现在：

- **VIS利用LIS的估计结果来加速初始化。**
- **通过在雷达测量数据中提取视觉特征所对应的深度信息，能够提升VIS的精度**。
- **LIS利用VIS的估计结果作为初值进行scan-matching**. 
- **闭环首先通过VIS进行查找，并通过LIS进行进一步的优化**。
- 当其中一个子系统失效时，LVI-SAM依然能够工作。这种设计使得该系统在纹理或者特征较少的环境中都能正常工作。

### 主要贡献

- 基于因子图的紧耦合LVIO框架，具有闭环识别的功能，能够实现多传感器融合和全局优化。
- 框架具有失败检测，兼容了子系统失败的情况。对传感器失效的情况更鲁棒。
- 框架具有通用性，对于不同规模，不同平台，以及不同环境的数据都有效。

### 视觉惯性系统

VIS处理图像和IMU数据，**雷达数据是可选配**的。视觉里程计通过最小化视觉和IMU测量的联合残差来得到里程计结果。改写主要包括两部分：提高VIS的初始化和特征深度估计。

#### 初始化

当解决的问题高度非线性时，基于优化的VIO在初始化阶段经常会发散。**初始化的质量主要取决于两个原因，初始传感器的运动，和IMU参数的准确性。**实际上，作者发现当传感器以一个非常小的速度或者匀速运动的时候，VINS在初始化的时候经常失败。原因是当加速度计的激励不够大的时候，尺度因子是不可观测的。IMU参数包括一个缓慢变化的偏差（bias）和白噪声，这些参数会影响原始的加速度计和角速度的测量值。在初始化时，对这些参数有一个好的估计，能够帮助优化更快的收敛。

论文利用了LIS估计得到的系统状态$X$和IMU偏差$b$，来提高VIS初始化的鲁棒性。因为深度值可以直接通过雷达测量得到，**首先对LIS进行初始化并且得到系统状态估计$X$和IMU偏差$b$。**然后，**基于图像的时间戳对$X$和$b$进行插值，将其关联到图像的关键帧**，并最终来作为VIS初始化的初值，这样能够极大的提高初始化的速度和鲁棒性。

#### 特征深度关联

VIO初始化之后，利用视觉里程计的估计结果将lidar坐标系对齐到相机坐标系（为什么不用外参，这样精度会更好吗？）。由于现代3D雷达通常声场的是稀疏的雷达扫描，通过**堆叠多帧雷达数据来获得稠密的深度地图**。为了将特征和深度值关联起来，首先**将视觉特征和雷达深度点投影到一个以相机为中心的单位球上**。之后对深度点进行**降采样**和利用极坐标存储，以便使其在球面上均匀分布。

我们利用二维KDTREE的方法，**在球面上找到距离视觉特征最近的三个深度点。这三个深度点能够构成一个平面，相机中心沿着特征点方向，与该平面的交点，即为特征深度点。**该点到相机的距离即特征深度。示意图可参见论文中图3.

我们通过检查三个点中最近的深度值，来进一步证实关联的特征深度。因为，堆叠不同时间戳的多帧雷达数据，可能会导致不同物体的深度歧义性。示意图见图3(b)，主要描述的问题是，当遇到障碍物遮挡问题时，由于在探测到的雷达扫描是不同的。且由于雷达数据会采用堆叠几帧的方式，在将雷达深度点关联到视觉特征上时，就会出现歧义性。这里采用的解决方案参考ref[17]，**当特征对应的深度点中最大的距离超过2m时，就拒绝该深度估计。即没有深度值和它进行关联**。（这里待查阅文献，最大距离超2m还是diff超2m?）可以从图4(a)中看到，图像窗口角落区域的许多特征点在检查环境失败了，而缺乏深度关联。

#### 失效检测

VIS在剧烈运动，光线变化，或者环境低纹理的情况下有可能导致失败。当机器人在剧烈运动，或者进入低纹理的环境中，跟踪到的特征点会大幅减少。不充分的特征有可能会导致优化发散。我们同时注意到，当VIS失效时，IMU bias估计值也会比较大。因此，**当跟踪到的特征数量低于某一阈值时，或者当估计的IMU bias超过某一阈值时**，我们会认为VIS是失败的。

对我们的系统来说，动态失败检测是必要的，这样VIS系统的失败不会破坏LIS的功能。一旦检测到失败，VIS将进行重新初始化，并及时通知LIS。（失效检测的召回率 是否足够高？）

#### 闭环检测

利用**DBoW2**进行闭环检测（后续优化点），对于每一个图像关键帧，我们提取BRIEF描述子，并且将他们与前面提取的描述子进行匹配。DBoW2返回的闭环候选结果的图像时间戳被传递给LIS进行进一步证实。



### 激光惯性系统

LIS改写自LIO-SAM，LIS维护了一个因子图进行全局位姿优化。**四种类型的约束（IMU预计分，视觉里程计约束，雷达里程计约束，和闭环约束）**被添加到了利用iSAM2构建因子图中联合优化（代码中看，似乎并未加入视觉里程计约束）。雷达里程计的约束通过将当前雷达关键帧和全局特征地图进行扫描匹配得到。闭环约束的候选帧首先由VIS提供，然后通过scan-matching进行进一步优化。我们为特征地图维护了一个滑动窗口，能确保计算复杂度的上限。当机器人位姿变化超过某一阈值时，就将该帧选择作为雷达关键帧。两个关键帧之间的雷达数据会被丢弃。在选择一个新的雷达关键帧后，一个新的机器人状态会作为一个节点被添加到图结构中。采用这种方式添加关键帧，不只能够保持内存消耗和地图密度的平衡，而且有助于维护一个相对稀疏的因子图从而实现实时优化。（LIS中使用多传感器图优化的目的是为了减少数据交换，以及提升系统效率。？）

#### 初值

初值在扫描匹配中具有重要的作用，特别当传感器传感器经历了剧烈运动的时候。LIS初始化前后采用的初值来源是不同的。

LIS初始化之前，我们假设机器人在一个静止的位置，速度为0的状态下开始。然后，假设IMU的测量值的偏差和噪声都是0的情况下（bias不能有初始标定吗？），对原始的IMU数据进行积分，得到两帧雷达关键帧之间的旋转量和平移量。并将得到的旋转量和平移量作为扫描匹配的初值。我们发现这种方法能够成功的初始化系统，即使在比较挑战的情况下，当初始线速度<10m/s&&角速度<180°/s。

一旦LIS初始化之后，我们能够通过因子图估计IMU bias，机器人位姿和速度。然后，我们将机器人位姿和IMU bias发送给VIS帮助其进行初始化。

LIS初始化之后，我们有两种方法得到初始估计，利用修正过bias的IMU进行积分得到，以及通过VIS得到。**当VIS的结果是可以使用的，就采用VIS的结果，如果VIS失败时，就切换为使用IMU预计分得到的。**这种方法增加了文理丰富和文理较少区域初值的准确性和鲁棒性。



#### 失效检测

虽然在较远的距离，捕获环境中的细节，它仍然有可能遇到退化的场景，scan-matching不能被很好的约束。此处采用ref[26]中的方法进行LIS失败检测。当优化问题第一次迭代时，$A^TA$的最小特征值小于某阈值时，即认为失败。当失败发生时，雷达里程计的结果不会添加到因子图中。